using Xunit;
using Moq;
using AutoFixture;
using System.Collections.Generic;
using System.Threading.Tasks;
using System.Linq;

public class YourServiceTests
{
    private readonly IFixture _fixture;
    private readonly Mock<IConfigRepository> _configRepoMock;
    private readonly Mock<ICurrentRepository> _currentRepoMock;
    private readonly YourService _sut; // System Under Test

    public YourServiceTests()
    {
        _fixture = new Fixture();

        _configRepoMock = new Mock<IConfigRepository>();
        _currentRepoMock = new Mock<ICurrentRepository>();

        _sut = new YourService(_configRepoMock.Object, _currentRepoMock.Object);
    }

    [Fact]
    public async Task PerformanceSummaryAffiliateAsync_ShouldReturnValidResponse_WhenRepositoriesReturnData()
    {
        // Arrange
        var request = _fixture.Create<GetKpiPerformanceRequest>();

        var affiliates = _fixture.Build<Affiliate>()
                                 .With(a => a.affiliateCode, _fixture.Create<string>())
                                 .CreateMany(3)
                                 .ToList();

        var plants = _fixture.CreateMany<GetCaseHierarchyResponse>(3).ToList();

        _configRepoMock.Setup(x => x.GetCaseHierarchyAsync(It.IsAny<GetCaseHierarchyRequest>()))
                       .ReturnsAsync(plants);

        _currentRepoMock.Setup(x => x.GetAffiliateLists())
                        .ReturnsAsync(affiliates);

        // Create random KpiFormula with delegate generated by AutoFixture
        var formulas = _fixture.Build<KpiFormula>()
                               .With(f => f.formula, new Func<decimal, decimal>(x => x / _fixture.Create<decimal>() + 1))
                               .With(f => f.name, _fixture.Create<string>)
                               .CreateMany(2)
                               .ToList();

        // Override helper methods if needed using reflection or internal test hooks
        // (optional, if they are not private)

        // Act
        var affiliateRequest = _fixture.Create<string>();
        var result = await _sut.PerformanceSummaryAffiliateAsync(request, affiliateRequest);

        // Assert
        Assert.NotNull(result);
        Assert.NotNull(result.kpis);
        Assert.True(result.kpis.Count >= 0);
        Assert.True(result.average >= 0);
        Assert.True(result.bestAffiliate >= 0);
        Assert.True(result.target >= 0);
        Assert.True(result.plants == null || result.plants.Count >= 0);

        // Verify repository calls
        _configRepoMock.Verify(x => x.GetCaseHierarchyAsync(It.IsAny<GetCaseHierarchyRequest>()), Times.Once);
        _currentRepoMock.Verify(x => x.GetAffiliateLists(), Times.Once);
    }

    [Fact]
    public async Task PerformanceSummaryAffiliateAsync_ShouldReturnDefaultResponse_WhenExceptionThrown()
    {
        // Arrange
        var request = _fixture.Create<GetKpiPerformanceRequest>();

        _configRepoMock.Setup(x => x.GetCaseHierarchyAsync(It.IsAny<GetCaseHierarchyRequest>()))
                       .ThrowsAsync(new System.Exception(_fixture.Create<string>()));

        // Act
        var result = await _sut.PerformanceSummaryAffiliateAsync(request, _fixture.Create<string>());

        // Assert
        Assert.NotNull(result);
        Assert.Null(result.kpis);
        Assert.Equal(0, result.average);
        Assert.Equal(0, result.bestAffiliate);
    }
}
